<!doctype html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cartes Rockin</title>

<!-- âœ… LLIBRERIA PER EXPORTAR IMATGE -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --bg:#f6f7f9;
  --accent:#ffcc00;

  /* estructurada */
  --struct-card-h:90px;
  --struct-gap:4px;
}

body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica;
  background:var(--bg);
  margin:0;
  padding:16px;
}

.layout{
  display:grid;
  grid-template-columns:360px 1fr;
  gap:14px;
}

/* ================= LEFT ================= */

.left{
  background:white;
  padding:12px;
  border-radius:16px;
}

.controls{
  display:flex;
  gap:8px;
  margin-bottom:10px;
}

select,button{
  padding:10px 12px;
  border-radius:12px;
  border:none;
  font-size:14px;
}

button{
  background:var(--accent);
  font-weight:700;
  cursor:pointer;
}

.cardStage{
  height:420px;
  background:white;
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

.cardImg{
  width:100%;
  height:100%;
  object-fit:contain;
}

/* ================= RIGHT ================= */

.boardWrap{
  background:white;
  border-radius:16px;
  padding:12px;
}

.boardTop{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
}

.zoomBtn{
  background:#eee;
}

.boardViewport{
  height:76vh;
  overflow:auto;
  border:2px dashed #ccc;
  border-radius:14px;
}

/* ================= FREE ================= */

.freeCanvas{
  position:relative;
  width:2600px;
  height:1600px;
  background:
    radial-gradient(circle at 1px 1px, rgba(0,0,0,.06) 1px, transparent 0) 0 0/24px 24px;
  transform-origin:0 0;
}

.freeBase{
  position:absolute;
  inset:0;
  z-index:1;
  pointer-events:none;
}
.freeOverlay{
  position:absolute;
  inset:0;
  z-index:5;
}

/* ================= THUMBS ================= */

.thumb{
  position:absolute;
  --w:150px;
  width:var(--w);
}

.thumb img{
  width:100%;
  pointer-events:none;
}

.handle{
  position:absolute;
  right:-6px;
  bottom:-6px;
  width:14px;
  height:14px;
  border-radius:50%;
  background:black;
  cursor:nwse-resize;
  opacity:0;
}
.thumb:hover .handle{opacity:1}

/* ================= STRUCTURED ================= */

.structuredWrap{
  padding:6px;
  transform-origin:0 0;
}

.matrix{
  display:grid;
  gap:var(--struct-gap);
  grid-template-columns:repeat(auto-fit,minmax(140px,170px));
}

.col{
  display:grid;
  gap:var(--struct-gap);
  padding:4px;
}

.cardSlot{
  height:var(--struct-card-h);
  background:#f1f1f1;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.cardSlot img{
  height:100%;
  object-fit:contain;
}

.hidden{display:none}
</style>
</head>

<body>

<div class="layout">

<!-- ================= LEFT ================= -->
<div class="left">

<div class="controls">
<select id="deck"></select>
<button id="btnNew">Nova carta</button>
</div>

<div class="cardStage">
<img id="imgTop" class="cardImg" draggable="true">
</div>

</div>

<!-- ================= RIGHT ================= -->
<div class="boardWrap">

<div class="boardTop">

<select id="mode">
<option value="free">Pissarra lliure</option>
<option value="structured">Pissarra estructurada</option>
</select>

<button id="zoomOut" class="zoomBtn">âˆ’</button>
<button id="zoomIn" class="zoomBtn">+</button>

<!-- âœ… NOU BOTÃ“ -->
<button id="btnExport" class="zoomBtn">ðŸ“¸ Descarrega</button>

<button id="btnProposal" class="zoomBtn">Proposta</button>

</div>

<div class="boardViewport">

<div id="freeCanvas" class="freeCanvas">
<div id="freeBase" class="freeBase"></div>
<div id="freeOverlay" class="freeOverlay"></div>
</div>

<div id="structuredWrap" class="structuredWrap hidden">
<div id="matrix" class="matrix"></div>
</div>

</div>
</div>
</div>

<script>

let MANIFEST={}
let zoom=1
let currentPath=null

const ROWS=["bateria","teclat","veu","baix","guitarra"]

/* ================= INIT ================= */

async function init(){
MANIFEST=await (await fetch("manifest.json")).json()

const deck=document.getElementById("deck")

Object.keys(MANIFEST).forEach(k=>{
 const o=document.createElement("option")
 o.value=k
 o.textContent=k
 deck.appendChild(o)
})

deck.onchange=()=>novaCarta()

document.getElementById("btnNew").onclick=novaCarta

document.getElementById("zoomIn").onclick=()=>setZoom(zoom+.1)
document.getElementById("zoomOut").onclick=()=>setZoom(zoom-.1)

document.getElementById("mode").onchange=applyMode

document.getElementById("btnProposal").onclick=buildProposal

/* ================= EXPORTAR PNG ================= */

document.getElementById("btnExport").onclick=async()=>{

 const mode=document.getElementById("mode").value

 const target=mode==="free"
   ? document.getElementById("freeCanvas")
   : document.getElementById("structuredWrap")

 const canvas=await html2canvas(target,{
   backgroundColor:"#ffffff",
   scale:2
 })

 const link=document.createElement("a")
 link.download="pissarra-rockin.png"
 link.href=canvas.toDataURL()
 link.click()
}

novaCarta()
}

function setZoom(z){
 zoom=Math.max(.5,Math.min(1.6,z))
 const el=document.getElementById(
   document.getElementById("mode").value==="free"
   ?"freeCanvas":"structuredWrap"
 )
 el.style.transform=`scale(${zoom})`
}

function applyMode(){
 const free=document.getElementById("freeCanvas")
 const structured=document.getElementById("structuredWrap")

 if(mode.value==="free"){
   free.classList.remove("hidden")
   structured.classList.add("hidden")
 }else{
   free.classList.add("hidden")
   structured.classList.remove("hidden")
 }
}

/* ================= CARTA ================= */

function novaCarta(){
 const deck=document.getElementById("deck").value
 const list=MANIFEST[deck]
 currentPath=list[Math.floor(Math.random()*list.length)]
 document.getElementById("imgTop").src=currentPath
}

/* ================= STRUCTURED ================= */

function buildProposal(){

 const matrix=document.getElementById("matrix")
 matrix.innerHTML=""

 const list=MANIFEST[Object.keys(MANIFEST).find(k=>k.toLowerCase().includes("creacio"))]

 for(let c=0;c<5;c++){

   const col=document.createElement("div")
   col.className="col"

   for(let r=0;r<5;r++){
     const slot=document.createElement("div")
     slot.className="cardSlot"

     if(Math.random()>.4){
       const img=document.createElement("img")
       img.src=list[r]
       slot.appendChild(img)
     }

     col.appendChild(slot)
   }

   matrix.appendChild(col)
 }
}

init()
</script>
</body>
</html>