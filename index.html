<!doctype html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cartes Rockin</title>

<style>
  :root{
    --bg:#f6f7f9;
    --text:#222;
    --accent:#ffcc00;
    --panel:#ffffff;
    --border:rgba(0,0,0,.18);
  }

  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica;
    background:var(--bg);
    color:var(--text);
    margin:0;
    padding:16px;
  }

  h1{
    margin:0 0 10px 0;
    font-size:24px;
    font-weight:650;
    text-align:left;
  }

  /* ===== Layout 2 columnes ===== */
  .layout{
    display:grid;
    grid-template-columns: 360px 1fr;
    gap:14px;
    align-items:start;
  }

  @media (max-width: 980px){
    .layout{ grid-template-columns: 1fr; }
  }

  /* ===== Panell esquerra ===== */
  .left{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:16px;
    box-shadow:0 10px 24px rgba(0,0,0,.06);
    padding:12px;
  }

  .controls{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
    margin-bottom:10px;
  }

  select, button{
    font-size:14px;
    padding:10px 12px;
    border-radius:12px;
  }

  select{
    border:1px solid rgba(0,0,0,.18);
    background:white;
    flex: 1 1 160px;
  }

  button{
    background:var(--accent);
    border:none;
    font-weight:700;
    cursor:pointer;
  }

  .hint{
    font-size:12px;
    opacity:.65;
    margin: 10px 0 0 0;
    line-height:1.35;
  }

  /* ===== Carta gran (rebot) ===== */
  .cardStage{
    width:100%;
    height: 420px;
    border-radius:16px;
    overflow:hidden;
    background:white;
    border:1px solid rgba(0,0,0,.10);
    box-shadow:0 10px 24px rgba(0,0,0,.10);
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }

  .cardStage.animate{
    animation: deal .38s cubic-bezier(.2,.9,.2,1);
  }

  @keyframes deal{
    0%{ transform:translateY(0); }
    35%{ transform:translateY(-10px); }
    70%{ transform:translateY(4px); }
    100%{ transform:translateY(0); }
  }

  .cardImg{
    width:100%;
    height:100%;
    object-fit:contain;
    background:white;
    user-select:none;
  }

  /* ===== Pissarra dreta ===== */
  .right{
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .boardWrap{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:16px;
    box-shadow:0 10px 24px rgba(0,0,0,.06);
    padding:12px;
  }

  /* Barra superior de la pissarra */
  .boardTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin: 0 0 10px 0;
  }

  .boardTopLeft{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .boardTitle{
    font-weight:650;
  }

  .zoomBar{
    display:flex;
    align-items:center;
    gap:6px;
    padding:4px 6px;
    border:1px solid rgba(0,0,0,.12);
    border-radius:12px;
    background:white;
  }

  .zoomBtn{
    background:#fff;
    border:1px solid rgba(0,0,0,.15);
    padding:6px 10px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
  }

  .zoomPct{
    font-size:12px;
    opacity:.75;
    width:46px;
    text-align:center;
    font-variant-numeric: tabular-nums;
  }

  /* mode selector */
  .modeSelect{
    border:1px solid rgba(0,0,0,.12);
    background:white;
    border-radius:12px;
    padding:8px 10px;
    font-size:13px;
  }

  /* Contenidor amb scroll en 2 direccions */
  .boardViewport{
    width:100%;
    height: 76vh;
    min-height: 520px;
    overflow:auto;
    border:2px dashed rgba(0,0,0,.20);
    border-radius:14px;
    background:white;
    position:relative;
  }

  .muted{
    font-size:12px;
    opacity:.65;
    margin-top:8px;
    padding:0 2px;
  }

  /* ====== MODE 1: PISSARRA LLIURE ====== */

  .freeCanvas{
    position:relative;
    width: 2600px;
    height: 1600px;
    transform-origin: 0 0;
    background:
      radial-gradient(circle at 1px 1px, rgba(0,0,0,.06) 1px, transparent 0) 0 0/24px 24px;
  }

  .thumb{
    position:absolute;
    --w: 150px;
    width: var(--w);
    height:auto;
    border:none;
    background:transparent;
    box-shadow:none;
    cursor:grab;
    user-select:none;
    touch-action:none;
  }

  .thumb:active{
    cursor:grabbing;
  }

  .thumb img{
    width:100%;
    height:auto;
    object-fit:contain;
    pointer-events:none;
    background:transparent;
    display:block;
  }

  .handle{
    position:absolute;
    right:-6px;
    bottom:-6px;
    width:14px;
    height:14px;
    border-radius:999px;
    background: rgba(0,0,0,.55);
    border: 2px solid rgba(255,255,255,.9);
    cursor: nwse-resize;
    touch-action:none;

    opacity:0;
    transform: scale(0.85);
    transition: opacity .12s ease, transform .12s ease;
    pointer-events:none;
  }

  .thumb:hover .handle,
  .thumb.is-active .handle{
    opacity:1;
    transform: scale(1);
    pointer-events:auto;
  }

  /* ====== MODE 2: PISSARRA ESTRUCTURADA ====== */

  .structured{
    transform-origin: 0 0;
    width: 2600px;      /* ample gran perquè hi capiguin columnes */
    min-height: 1600px;
    padding: 14px;
    box-sizing: border-box;
    background:
      radial-gradient(circle at 1px 1px, rgba(0,0,0,.05) 1px, transparent 0) 0 0/24px 24px;
  }

  .columns{
    display:grid;
    gap:14px;
    align-items:start;
  }

  .col{
    background: rgba(255,255,255,.85);
    border:1px solid rgba(0,0,0,.10);
    border-radius:14px;
    padding:10px;
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
    min-height: 240px;
  }

  .colTitle{
    font-weight:650;
    font-size:13px;
    opacity:.85;
    margin-bottom:10px;
    display:flex;
    justify-content:space-between;
    gap:8px;
    align-items:center;
  }

  .colCards{
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .optionCard{
    width: 100%;
    aspect-ratio: 2 / 3;      /* format carta consistent */
    background: transparent;
    border: none;
  }

  .optionCard img{
    width:100%;
    height:100%;
    object-fit:contain;       /* no retalla */
    display:block;
  }

  .miniBtn{
    background: #fff;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 10px;
    padding: 6px 10px;
    cursor:pointer;
    font-weight:700;
    font-size:12px;
  }

  .miniBtn:hover{ filter: brightness(.98); }

  .hidden{ display:none !important; }
</style>
</head>

<body>

<h1>Cartes Rockin</h1>

<div class="layout">

  <!-- ESQUERRA -->
  <div class="left">
    <div class="controls">
      <select id="deck"></select>
      <button id="btnNew" type="button">Nova carta</button>
      <button id="btnClear" type="button">Neteja pissarra</button>
    </div>

    <div class="cardStage" id="cardStage">
      <img id="imgTop" class="cardImg" draggable="true" alt="Carta actual">
    </div>

    <p class="hint">
      <b>Enter</b> = nova carta · <b>Arrossega</b> la carta a la pissarra ·
      En mode lliure: mou + canvia mida per carta · En mode estructurat: genera opcions de Creació.
    </p>
  </div>

  <!-- DRETA -->
  <div class="right">
    <div class="boardWrap">

      <div class="boardTop">
        <div class="boardTopLeft">
          <div class="boardTitle">Pissarra</div>

          <!-- Selector de mode -->
          <select id="mode" class="modeSelect" aria-label="Mode pissarra">
            <option value="free">Pissarra lliure</option>
            <option value="structured">Pissarra estructurada</option>
          </select>

          <!-- Zoom -->
          <div class="zoomBar" aria-label="Zoom pissarra">
            <button class="zoomBtn" id="zoomOut" type="button">−</button>
            <div class="zoomPct" id="zoomPct">100%</div>
            <button class="zoomBtn" id="zoomIn" type="button">+</button>
          </div>

          <!-- Botó només per estructurada -->
          <button class="miniBtn hidden" id="btnGenerate" type="button">Genera opcions</button>
        </div>

        <div style="font-size:12px;opacity:.65;">scroll X/Y</div>
      </div>

      <div class="boardViewport" id="boardViewport">
        <!-- MODE FREE -->
        <div class="freeCanvas" id="freeCanvas"></div>

        <!-- MODE STRUCTURED -->
        <div class="structured hidden" id="structured">
          <div class="columns" id="columns"></div>
        </div>
      </div>

      <div class="muted">El zoom afecta el mode actiu. Scroll vertical i horitzontal per moure’t per la pissarra gran.</div>
    </div>
  </div>

</div>

<script>
/* =========================
   PARÀMETRES ESTRUCTURADA
   (modifica aquí)
========================= */
const STRUCT_COLS = 5          // X columnes verticals
const MIN_OPTS = 1             // mínim d’opcions per columna
const MAX_OPTS = 4             // màxim d’opcions per columna

/* ========================= */

let MANIFEST = {}
let barallaActual = []
let barallaRestant = []
let currentPath = null

let zoom = 1.0
const ZOOM_MIN = 0.5
const ZOOM_MAX = 1.4
const ZOOM_STEP = 0.1

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1))
    ;[a[i],a[j]]=[a[j],a[i]]
  }
  return a
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)) }

async function init(){
  const res = await fetch("manifest.json")
  MANIFEST = await res.json()

  // deck selector
  const select = document.getElementById("deck")
  Object.keys(MANIFEST).forEach(b=>{
    const opt = document.createElement("option")
    opt.value = b
    opt.textContent = b
    select.appendChild(opt)
  })
  select.addEventListener("change", carregarBaralla)

  document.getElementById("btnNew").addEventListener("click", novaCarta)
  document.getElementById("btnClear").addEventListener("click", clearBoard)

  document.addEventListener("keydown", e=>{
    if(e.key === "Enter") novaCarta()
  })

  // zoom
  document.getElementById("zoomIn").addEventListener("click", ()=> setZoom(zoom + ZOOM_STEP))
  document.getElementById("zoomOut").addEventListener("click", ()=> setZoom(zoom - ZOOM_STEP))
  updateZoomUI()

  // mode selector
  const modeSel = document.getElementById("mode")
  modeSel.addEventListener("change", applyMode)

  // generate structured
  document.getElementById("btnGenerate").addEventListener("click", generateStructured)

  // drag from main card -> free board only (when free active)
  const imgTop = document.getElementById("imgTop")
  imgTop.addEventListener("dragstart", (e)=>{
    if(!currentPath) return
    e.dataTransfer.setData("text/plain", currentPath)
    e.dataTransfer.effectAllowed = "copy"
  })

  // drop on free canvas
  const freeCanvas = document.getElementById("freeCanvas")
  freeCanvas.addEventListener("dragover", e => e.preventDefault())
  freeCanvas.addEventListener("drop", e=>{
    e.preventDefault()

    // si no estem en mode free, ignorem drop
    if(getMode() !== "free") return

    const path = e.dataTransfer.getData("text/plain")
    if(!path) return

    const rect = freeCanvas.getBoundingClientRect()
    const x = (e.clientX - rect.left) / zoom
    const y = (e.clientY - rect.top) / zoom

    addThumb(path, x, y)
  })

  carregarBaralla()
  setZoom(1.0)
  applyMode()
}

function getMode(){
  return document.getElementById("mode").value
}

function setZoom(z){
  zoom = clamp(z, ZOOM_MIN, ZOOM_MAX)

  // aplica zoom a qui estigui actiu
  if(getMode() === "free"){
    document.getElementById("freeCanvas").style.transform = `scale(${zoom})`
  }else{
    document.getElementById("structured").style.transform = `scale(${zoom})`
  }
  updateZoomUI()
}

function updateZoomUI(){
  document.getElementById("zoomPct").textContent = Math.round(zoom * 100) + "%"
}

function applyMode(){
  const mode = getMode()
  const freeCanvas = document.getElementById("freeCanvas")
  const structured = document.getElementById("structured")
  const btnGen = document.getElementById("btnGenerate")

  if(mode === "free"){
    freeCanvas.classList.remove("hidden")
    structured.classList.add("hidden")
    btnGen.classList.add("hidden")

    // assegura transform del free
    freeCanvas.style.transformOrigin = "0 0"
    freeCanvas.style.transform = `scale(${zoom})`
  }else{
    structured.classList.remove("hidden")
    freeCanvas.classList.add("hidden")
    btnGen.classList.remove("hidden")

    // assegura transform de structured
    structured.style.transformOrigin = "0 0"
    structured.style.transform = `scale(${zoom})`

    // si encara no hi ha res, generem
    if(!document.getElementById("columns").children.length){
      generateStructured()
    }
  }
}

/* ===== Randomització carta gran ===== */

function carregarBaralla(){
  const deck = document.getElementById("deck").value
  barallaActual = [...MANIFEST[deck]]
  barallaRestant = shuffle([...barallaActual])
  novaCarta()
}

function setMainImg(path){
  const img = document.getElementById("imgTop")
  const url = new URL(path, window.location.href)
  url.searchParams.set("t", Date.now())
  img.src = url.toString()
}

function novaCarta(){
  if(barallaRestant.length === 0){
    barallaRestant = shuffle([...barallaActual])
  }

  const path = barallaRestant.pop()
  currentPath = path
  setMainImg(path)

  const stage = document.getElementById("cardStage")
  stage.classList.remove("animate")
  void stage.offsetWidth
  stage.classList.add("animate")
}

/* ===== Pissarra lliure: cartes movibles i redimensionables ===== */

function addThumb(path, x, y){
  const canvas = document.getElementById("freeCanvas")

  const t = document.createElement("div")
  t.className = "thumb"
  t.style.setProperty("--w", "150px")

  const img = document.createElement("img")
  const url = new URL(path, window.location.href)
  url.searchParams.set("t", Date.now())
  img.src = url.toString()

  const handle = document.createElement("div")
  handle.className = "handle"
  handle.title = "Arrossega per canviar la mida"

  t.appendChild(img)
  t.appendChild(handle)

  t.style.left = (x - 75) + "px"
  t.style.top  = (y - 90) + "px"

  t.addEventListener("dblclick", ()=> t.remove())

  makeMovable(t, canvas)
  makeResizable(t, handle)

  canvas.appendChild(t)
}

function makeMovable(el, canvas){
  let startX=0, startY=0, origL=0, origT=0
  let dragging = false

  el.addEventListener("pointerdown", (e)=>{
    if(e.target && e.target.classList.contains("handle")) return

    dragging = true
    el.classList.add("is-active")
    el.setPointerCapture(e.pointerId)
    el.style.zIndex = String(Date.now())

    startX = e.clientX
    startY = e.clientY
    origL = parseFloat(el.style.left || "0")
    origT = parseFloat(el.style.top  || "0")
  })

  el.addEventListener("pointermove", (e)=>{
    if(!dragging) return
    const dx = (e.clientX - startX) / zoom
    const dy = (e.clientY - startY) / zoom

    const canvasW = canvas.clientWidth
    const canvasH = canvas.clientHeight

    const w = el.getBoundingClientRect().width / zoom
    const h = el.getBoundingClientRect().height / zoom

    let newL = origL + dx
    let newT = origT + dy

    newL = clamp(newL, 0, canvasW - w)
    newT = clamp(newT, 0, canvasH - h)

    el.style.left = newL + "px"
    el.style.top  = newT + "px"
  })

  el.addEventListener("pointerup", (e)=>{
    dragging = false
    el.classList.remove("is-active")
    try{ el.releasePointerCapture(e.pointerId) }catch(_){}
  })

  el.addEventListener("pointercancel", ()=>{
    dragging = false
    el.classList.remove("is-active")
  })
}

function makeResizable(el, handle){
  let startX=0, startW=150
  let resizing = false

  handle.addEventListener("pointerdown", (e)=>{
    resizing = true
    el.classList.add("is-active")
    handle.setPointerCapture(e.pointerId)
    el.style.zIndex = String(Date.now())

    startX = e.clientX
    startW = parseFloat(getComputedStyle(el).getPropertyValue("--w")) || 150

    e.preventDefault()
    e.stopPropagation()
  })

  handle.addEventListener("pointermove", (e)=>{
    if(!resizing) return
    const dx = (e.clientX - startX) / zoom
    const newW = clamp(startW + dx, 60, 520)
    el.style.setProperty("--w", newW + "px")
  })

  handle.addEventListener("pointerup", (e)=>{
    resizing = false
    el.classList.remove("is-active")
    try{ handle.releasePointerCapture(e.pointerId) }catch(_){}
  })

  handle.addEventListener("pointercancel", ()=>{
    resizing = false
    el.classList.remove("is-active")
  })
}

/* ===== Pissarra estructurada ===== */

function normalizeKey(s){
  // treu accents i passa a minúscules
  return (s || "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
}

function findCreationDeckKey(){
  const keys = Object.keys(MANIFEST)
  const target = keys.find(k => normalizeKey(k).includes("creacio"))
  return target || null
}

function generateStructured(){
  const creationKey = findCreationDeckKey()
  const colsWrap = document.getElementById("columns")
  colsWrap.innerHTML = ""

  // define grid columns
  colsWrap.style.gridTemplateColumns = `repeat(${STRUCT_COLS}, minmax(220px, 1fr))`

  if(!creationKey){
    // si no trobem la baralla, mostrem un avís dins d’una columna
    const c = document.createElement("div")
    c.className = "col"
    c.innerHTML = `
      <div class="colTitle">No trobo la baralla “Creació”</div>
      <div style="font-size:12px;opacity:.7;line-height:1.4">
        Al manifest no hi ha cap clau que contingui “Creacio/Creació”.<br>
        Revisa el nom de la carpeta/baralla al manifest.json.
      </div>
    `
    colsWrap.appendChild(c)
    return
  }

  // preparem un pool de cartes de creació
  const pool = [...MANIFEST[creationKey]]
  shuffle(pool)

  for(let i=0;i<STRUCT_COLS;i++){
    const nOpts = randInt(MIN_OPTS, MAX_OPTS)

    const col = document.createElement("div")
    col.className = "col"

    const title = document.createElement("div")
    title.className = "colTitle"
    title.innerHTML = `<span>Columna ${i+1}</span><span style="opacity:.6">${nOpts} opcions</span>`

    const cards = document.createElement("div")
    cards.className = "colCards"

    for(let j=0;j<nOpts;j++){
      // si s'acaba el pool, tornem a barrejar
      if(pool.length === 0){
        pool.push(...MANIFEST[creationKey])
        shuffle(pool)
      }

      const path = pool.pop()
      const card = document.createElement("div")
      card.className = "optionCard"

      const img = document.createElement("img")
      const url = new URL(path, window.location.href)
      url.searchParams.set("t", Date.now())
      img.src = url.toString()
      img.alt = `Opció ${j+1}`

      card.appendChild(img)
      cards.appendChild(card)
    }

    col.appendChild(title)
    col.appendChild(cards)
    colsWrap.appendChild(col)
  }
}

function randInt(min,max){
  return Math.floor(Math.random()*(max-min+1)) + min
}

/* ===== Clear segons mode ===== */
function clearBoard(){
  if(getMode() === "free"){
    document.getElementById("freeCanvas").innerHTML = ""
  }else{
    document.getElementById("columns").innerHTML = ""
  }
}

init()
</script>

</body>
</html>