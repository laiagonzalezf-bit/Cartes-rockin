<!doctype html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<title>Cartes Rockin</title>

<style>
body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica;
  background:#f6f7f9;
  color:#222;
  text-align:center;
  margin:0;
  padding:26px;
}

h1{
  margin:0 0 14px 0;
  font-size:30px;
  font-weight:650;
}

.controls{
  margin-bottom:14px;
}

select, button{
  font-size:16px;
  padding:10px 14px;
  border-radius:12px;
  margin:6px;
}

select{
  border:1px solid #cfcfcf;
  background:white;
}

button{
  background:#ffcc00;
  border:none;
  font-weight:700;
  cursor:pointer;
}

/* =================================================
   CARTA GRAN (rebot)
================================================= */

.stage{
  width:min(92vw, 980px);
  margin:auto;
}

.deck{
  position:relative;
  width:100%;
  height:min(60vh, 600px);
  display:flex;
  align-items:center;
  justify-content:center;
}

.card{
  position:absolute;
  width:100%;
  height:100%;
  border-radius:18px;
  overflow:hidden;
  background:white;
  box-shadow:0 10px 30px rgba(0,0,0,.18);
}

.card img{
  width:100%;
  height:100%;
  object-fit:contain;
}

.card.back2{
  transform: translateY(16px) scale(.97) rotate(-1deg);
  opacity:.6;
}

.card.back1{
  transform: translateY(9px) scale(.985) rotate(.8deg);
  opacity:.78;
}

.card.top.animate{
  animation: deal .42s cubic-bezier(.2,.9,.2,1);
}

@keyframes deal{
  0%{transform:translateY(0)}
  35%{transform:translateY(-10px)}
  70%{transform:translateY(4px)}
  100%{transform:translateY(0)}
}

.hint{
  margin:12px 0 18px;
  font-size:13px;
  opacity:.65;
}

/* =================================================
   PISSARRA
================================================= */

.board-wrap{
  width:min(92vw,1100px);
  margin:auto;
  text-align:left;
}

.board-head{
  display:flex;
  justify-content:space-between;
  margin-bottom:8px;
}

.board{
  position:relative;
  width:100%;
  min-height:700px; /* 5+ files */
  background:white;
  border:2px dashed rgba(0,0,0,.2);
  border-radius:16px;
  overflow:hidden;
}

/* MINI-CARTES – més petites i proporció real */

.thumb{
  position:absolute;

  width:120px;   /* ← més petit */
  height:auto;

  border:none;
  background:transparent;
  box-shadow:none;

  cursor:grab;
  user-select:none;
  touch-action:none;
}

.thumb:active{
  cursor:grabbing;
  transform:scale(1.05);
}

.thumb img{
  width:100%;
  height:auto;
  object-fit:contain;
  pointer-events:none;
}

.muted{
  font-size:13px;
  opacity:.6;
  margin-top:8px;
}
</style>
</head>

<body>

<h1>Cartes Rockin</h1>

<div class="controls">
  <select id="deck"></select>
  <button onclick="novaCarta()">Nova carta</button>
</div>

<div class="stage">
  <div class="deck">
    <div class="card back2"><img id="imgBack2"></div>
    <div class="card back1"><img id="imgBack1"></div>
    <div class="card top" id="topCard"><img id="imgTop" draggable="true"></div>
  </div>
</div>

<div class="hint">
Enter = nova carta · arrossega cap a la pissarra · mou-les lliurement · doble clic per eliminar
</div>

<div class="board-wrap">
  <div class="board-head">
    <strong>Pissarra</strong>
    <button id="clearBoard">Neteja pissarra</button>
  </div>

  <div id="board" class="board"></div>
  <div class="muted">Col·loca les cartes on vulguis, com en una pissarra real.</div>
</div>

<script>
let MANIFEST={}
let barallaActual=[]
let barallaRestant=[]
let currentPath=null

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1))
    ;[a[i],a[j]]=[a[j],a[i]]
  }
  return a
}

async function init(){
  const res=await fetch("manifest.json")
  MANIFEST=await res.json()

  const select=document.getElementById("deck")

  Object.keys(MANIFEST).forEach(b=>{
    const o=document.createElement("option")
    o.value=b
    o.textContent=b
    select.appendChild(o)
  })

  select.onchange=carregarBaralla
  document.addEventListener("keydown",e=>{ if(e.key==="Enter") novaCarta() })

  const imgTop=document.getElementById("imgTop")
  imgTop.addEventListener("dragstart",e=>{
    if(!currentPath) return
    e.dataTransfer.setData("text/plain",currentPath)
  })

  const board=document.getElementById("board")

  board.addEventListener("dragover",e=>e.preventDefault())

  board.addEventListener("drop",e=>{
    e.preventDefault()

    const path=e.dataTransfer.getData("text/plain")
    if(!path) return

    const rect=board.getBoundingClientRect()

    addThumb(path, e.clientX-rect.left, e.clientY-rect.top)
  })

  document.getElementById("clearBoard").onclick=()=>board.innerHTML=""

  carregarBaralla()
}

function setImg(id,path){
  const img=document.getElementById(id)
  if(!path){ img.removeAttribute("src"); return }
  const url=new URL(path,window.location.href)
  url.searchParams.set("t",Date.now())
  img.src=url.toString()
}

function carregarBaralla(){
  const deck=document.getElementById("deck").value
  barallaActual=[...MANIFEST[deck]]
  barallaRestant=shuffle([...barallaActual])
  novaCarta()
}

function novaCarta(){
  if(barallaRestant.length===0) barallaRestant=shuffle([...barallaActual])

  const path=barallaRestant.pop()
  currentPath=path

  setImg("imgTop",path)

  const top=document.getElementById("topCard")
  top.classList.remove("animate")
  void top.offsetWidth
  top.classList.add("animate")
}

function addThumb(path,x,y){
  const board=document.getElementById("board")

  const t=document.createElement("div")
  t.className="thumb"

  const img=document.createElement("img")
  const url=new URL(path,window.location.href)
  url.searchParams.set("t",Date.now())
  img.src=url.toString()

  t.appendChild(img)

  /* centrat segons nova mida (120px aprox) */
  t.style.left=(x-60)+"px"
  t.style.top=(y-45)+"px"

  t.ondblclick=()=>t.remove()

  makeDraggable(t)

  board.appendChild(t)
}

function makeDraggable(el){
  let startX,startY,origX,origY

  el.onpointerdown=e=>{
    el.setPointerCapture(e.pointerId)
    startX=e.clientX
    startY=e.clientY
    origX=parseFloat(el.style.left)
    origY=parseFloat(el.style.top)
  }

  el.onpointermove=e=>{
    if(e.buttons!==1) return
    el.style.left=(origX+e.clientX-startX)+"px"
    el.style.top=(origY+e.clientY-startY)+"px"
  }
}

init()
</script>

</body>
</html>