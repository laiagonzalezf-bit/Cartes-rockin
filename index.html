<!doctype html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<title>Cartes Rockin</title>

<style>
:root{
  --thumb-size:120px;
}

body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica;
  background:#f6f7f9;
  margin:0;
  padding:18px;
}

.layout{
  display:grid;
  grid-template-columns:360px 1fr;
  gap:16px;
}

/* ===== CARTA GRAN ===== */

.cardStage{
  height:420px;
  background:white;
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

.cardStage img{
  width:100%;
  height:100%;
  object-fit:contain;
}

/* ===== PISSARRA ===== */

.boardViewport{
  height:75vh;
  overflow:auto;
  border:2px dashed #ccc;
  border-radius:14px;
}

.boardCanvas{
  position:relative;
  width:2600px;
  height:1600px;
  background:
    radial-gradient(circle at 1px 1px, rgba(0,0,0,.05) 1px, transparent 0) 0 0/24px 24px;
}

/* MINI-CARTES DINÃ€MIQUES */

.thumb{
  position:absolute;
  width:var(--thumb-size);
  aspect-ratio:2/3;
  cursor:grab;
}

.thumb img{
  width:100%;
  height:100%;
  object-fit:contain;
  pointer-events:none;
}

.thumb:active{
  transform:scale(1.05);
}

.rotate90{
  transform:rotate(90deg);
}
</style>
</head>

<body>

<div class="layout">

<div>
<select id="deck"></select>
<button onclick="novaCarta()">Nova carta</button>

<div class="cardStage">
  <img id="imgTop" draggable="true">
</div>
</div>

<div>

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
  <strong>Pissarra</strong>

  <label style="font-size:13px">
    Mida cartes
    <input type="range" id="sizeSlider" min="70" max="220" value="120">
  </label>
</div>

<div class="boardViewport">
  <div id="boardCanvas" class="boardCanvas"></div>
</div>

</div>

</div>

<script>
let MANIFEST={}
let barallaActual=[]
let barallaRestant=[]
let currentPath=null
let rotate=false

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1))
    ;[a[i],a[j]]=[a[j],a[i]]
  }
  return a
}

async function init(){
  MANIFEST=await (await fetch("manifest.json")).json()

  const select=document.getElementById("deck")
  Object.keys(MANIFEST).forEach(b=>{
    const o=document.createElement("option")
    o.value=b
    o.textContent=b
    select.appendChild(o)
  })

  select.onchange=carregarBaralla

  document.getElementById("sizeSlider").oninput=(e)=>{
    document.documentElement.style.setProperty("--thumb-size", e.target.value+"px")
  }

  const img=document.getElementById("imgTop")
  img.ondragstart=e=>{
    e.dataTransfer.setData("text/plain",currentPath)
    e.dataTransfer.setData("rotate",rotate?1:0)
  }

  const canvas=document.getElementById("boardCanvas")

  canvas.ondragover=e=>e.preventDefault()

  canvas.ondrop=e=>{
    e.preventDefault()
    const path=e.dataTransfer.getData("text/plain")
    const rot=e.dataTransfer.getData("rotate")==="1"

    const rect=canvas.getBoundingClientRect()

    addThumb(path,e.clientX-rect.left,e.clientY-rect.top,rot)
  }

  carregarBaralla()
}

function carregarBaralla(){
  const deck=document.getElementById("deck").value
  rotate=deck.toLowerCase().includes("bateria")

  barallaActual=[...MANIFEST[deck]]
  barallaRestant=shuffle([...barallaActual])
  novaCarta()
}

function novaCarta(){
  if(barallaRestant.length===0) barallaRestant=shuffle([...barallaActual])

  currentPath=barallaRestant.pop()

  const url=new URL(currentPath,location.href)
  document.getElementById("imgTop").src=url
  document.getElementById("imgTop").classList.toggle("rotate90",rotate)
}

function addThumb(path,x,y,rot){
  const t=document.createElement("div")
  t.className="thumb"

  const img=document.createElement("img")
  img.src=path
  if(rot) img.classList.add("rotate90")

  t.appendChild(img)

  t.style.left=x+"px"
  t.style.top=y+"px"

  makeDrag(t)

  document.getElementById("boardCanvas").appendChild(t)
}

function makeDrag(el){
  let sx,sy,ox,oy
  el.onpointerdown=e=>{
    el.setPointerCapture(e.pointerId)
    sx=e.clientX; sy=e.clientY
    ox=parseFloat(el.style.left); oy=parseFloat(el.style.top)
  }
  el.onpointermove=e=>{
    if(e.buttons!==1) return
    el.style.left=(ox+e.clientX-sx)+"px"
    el.style.top=(oy+e.clientY-sy)+"px"
  }
}

init()
</script>

</body>
</html>